
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <title>Village-Update-Requests</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="Phoenixcoded" />
  <link rel="icon" th:href="@{/Village/VillageAdmin/assets/images/favicon.ico}" type="image/x-icon">
  <link rel="stylesheet" th:href="@{/Admin/assets/css/style.css}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .modal-content {
          background-color: #fff;
          color: #000;
          border-radius: 1rem;
          border: 1px solid #ddd;
        }

        .modal-header {
          background-color: #fff;
          color: #000;
          border-bottom: 1px solid #ccc;
        }

        .modal-title {
          font-weight: 600;
          font-size: 1.25rem;
        }

        .btn-close {
          filter: invert(1); /* makes close icon black */
        }

        .fw-bold.text-primary,
        .fw-bold.text-secondary {
          color: #000 !important;
          border-bottom: 2px solid #000;
          padding-bottom: 0.3rem;
          margin-bottom: 1rem;
          display: inline-block;
        }


        .img-fluid.rounded.shadow-sm.border {
          border: 1px solid #000;
          box-shadow: none;
        }

        .modal-footer .btn {
          min-width: 100px;
          font-weight: 600;
          border-radius: 0.5rem;
        }

        .modal-footer .btn-secondary {
          background-color: #000;
          color: #fff;
          border: none;
        }

        .modal-footer .btn-secondary:hover {
          background-color: #222;
        }

        .modal-footer .btn-success {
          background-color: #16a34a;
          color: #fff;
          border: none;
        }

        .modal-footer .btn-success:hover {
          background-color: #15803d;
        }

        .modal-footer .btn-danger {
          background-color: #ef4444;
          color: #fff;
          border: none;
        }

        .modal-footer .btn-danger:hover {
          background-color: #dc2626;
        }

        @media (max-width: 768px) {
          .modal-dialog {
            max-width: 100%;
          }
        }
        .swal2-container {
          z-index: 9999 !important;
        }
        #rejectModal .modal-content {
            border-radius: 8px;
        }
        #rejectModal textarea:focus {
            border-color: #000;
            box-shadow: none;
        }
        .notification.unread {
        background-color: #f5f5f5;
        border-left: 4px solid #28a745;
        }
        .notification.read {
            opacity: 0.7;
        }
           .noti-head {
        background-color: #000;
        color: #fff;
        padding: 10px;
        }

        .noti-head a {
            color: #fff !important;
            text-decoration: none;
            font-weight: 500;
        }

        .noti-head a:hover {
            text-decoration: underline;
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }

        .notification-item.unread {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .notification-item.read {
            background-color: #e0e0e0;
            font-weight: normal;
        }

    </style>
</head>
<body class="">
<div class="loader-bg">
  <div class="loader-track">
    <div class="loader-fill"></div>
  </div>
</div>
<nav class="pcoded-navbar  ">
  <div class="navbar-wrapper  ">
    <div class="navbar-content scroll-div " >

      <div class="">
        <div class="main-menu-header">
          <img class="img-radius" th:src="@{'/uploads/admin/' + ${admin.adminProfileImage}}" alt="Admin">
          <div class="user-details">
            <span th:text="${admin.adminName}"></span>
            <div id="more-details">Administrator<i class="fa fa-chevron-down m-l-5"></i></div>
          </div>
        </div>
        <div class="collapse" id="nav-user-link">
          <ul class="list-unstyled">
            <li class="list-group-item"><a th:href="@{/admin/profile}"><i class="feather icon-user m-r-5"></i>View Profile</a></li>
            <li class="list-group-item"><a th:href="@{/admin/logout}"><i class="feather icon-log-out m-r-5"></i>Logout</a></li>
          </ul>
        </div>
      </div>

        <ul class="nav pcoded-inner-navbar ">
            <li class="nav-item pcoded-menu-caption">
                <label>Home</label>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/home}" class="nav-link "><span class="pcoded-micon"><i class="feather icon-home"></i></span><span class="pcoded-mtext">Dashboard</span></a>
            </li>
            <li class="nav-item pcoded-hasmenu">
                <a href="#!" class="nav-link "><span class="pcoded-micon"><i class="feather icon-layout"></i></span><span class="pcoded-mtext">Village</span></a>
                <ul class="pcoded-submenu">
                    <li><a th:href="@{/admin/requests}" >Requests</a></li>
                    <li><a th:href="@{/admin/viewAllVillages}" >View All</a></li>
                    <li><a th:href="@{/admin/viewPendingVillageEditRequests}" >Update-Requests</a></li>
                    <li><a th:href="@{/admin/updatedVillages}" >All Update Reqs</a></li>
                </ul>
            </li>
            <li class="nav-item pcoded-menu-caption">
                <label>Cultural Activities</label>
            </li>
            <li class="nav-item pcoded-hasmenu">
                <a href="#!" class="nav-link "><span class="pcoded-micon"><i class="feather icon-box"></i></span><span class="pcoded-mtext">Activities</span></a>
                <ul class="pcoded-submenu">
                    <li><a th:href="@{/admin/viewActivityRequests}" >Requests</a></li>
                    <li><a th:href="@{/admin/viewAllActivities}" >View All</a></li>
                </ul>
            </li>
            <li class="nav-item pcoded-menu-caption">
                <label>Others</label>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/allUsers}" class="nav-link "><span class="pcoded-micon"><i class="feather icon-file-text"></i></span><span class="pcoded-mtext">Users</span></a>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/feedbacks}" class="nav-link "><span class="pcoded-micon"><i class="feather icon-align-justify"></i></span><span class="pcoded-mtext">FeedBacks</span></a>
            </li>
        </ul>
    </div>
  </div>
</nav>
<header class="navbar pcoded-header navbar-expand-lg navbar-light header-dark">


  <div class="m-header">
    <a class="mobile-menu" id="mobile-collapse" href="#!"><span></span></a>
    <a href="#!" class="b-brand">
      <img src="/Admin/assets/images/logo.png" alt="" class="logo">
      <img src="/Admin/assets/images/logo-icon.png" alt="" class="logo-thumb">
    </a>
    <a href="#!" class="mob-toggler">
      <i class="feather icon-more-vertical"></i>
    </a>
  </div>
  <div class="collapse navbar-collapse">
    <ul class="navbar-nav ml-auto">
        <li>
            <div class="dropdown">
                <a class="dropdown-toggle" href="#" data-toggle="dropdown">
                    <i class="icon feather icon-bell"></i>
                    <span id="notification-count" class="badge badge-pill badge-danger"
                          th:text="${messages.size()}">0</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right notification">
                    <div class="noti-head">
                        <h6 class="d-inline-block m-b-0">Notifications</h6>
                        <div class="float-right">
                            <a href="#!" class="mark-read-link m-r-10">mark as read</a>
                            <a href="#!" class="clear-all-link">clear all</a>
                        </div>
                    </div>
                    <ul class="noti-body">
                        <li class="n-title"><p class="m-b-0">NEW</p></li>
                        <li class="notification"
                            th:each="message : ${messages}"
                            th:data-id="${message.id}"
                            th:classappend="${message.isRead} ? 'read' : 'unread'">
                            <div class="media">
                                <img class="img-radius"
                                     th:src="${message.village?.villageProfileImage != null ? '/uploads/village/' + message.village.villageProfileImage : '/Admin/assets/images/user/default.jpg'}"
                                     alt="Village image">
                                <div class="media-body">
                                    <p>
                                        <strong th:text="${message.village?.villageName ?: 'Unknown Village'}">Village Name</strong>
                                        <span class="n-time text-muted">
                                                <i class="icon feather icon-clock m-r-10"></i>
                                                <span th:text="${message.timestamp != null ? #temporals.format(message.timestamp, 'HH:mm') : 'â€”'}"></span>
                                            </span>
                                        <span th:if="${#temporals.day(message.timestamp) == #temporals.day(#temporals.createNow())}"
                                              class="badge bg-success ml-2">New</span>
                                    </p>
                                    <p th:text="${message.message}">Message content</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="noti-footer">
                        <a th:href="@{/admin/inbox}">show all</a>
                    </div>
                </div>
            </div>
        </li>
      <li>
        <div class="dropdown drp-user">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <i class="feather icon-user"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right profile-notification">
            <div class="pro-head">
              <img th:src="@{'/uploads/admin/' + ${admin.adminProfileImage}}" alt="Admin" class="img-radius" >
              <span th:text="${admin.adminName}"></span>
              <a th:href="@{/admin/logout}" class="dud-logout" title="Logout">
                <i class="feather icon-log-out"></i>
              </a>
            </div>
            <ul class="pro-body">
              <li><a th:href="@{/admin/profile}" class="dropdown-item"><i class="feather icon-user"></i> Profile</a></li>
              <li><a th:href="@{/admin/viewResetPassword}" class="dropdown-item"><i class="feather icon-mail"></i>Reset-Password</a></li>
              <li><a th:href="@{/admin/logout}" class="dropdown-item"><i class="feather icon-lock"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </li>
    </ul>
  </div>


</header>

<div class="pcoded-main-container">
  <div class="pcoded-content">
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="m-b-10">Village Update Requests</h5>
            </div>
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a th:href="@{/admin/home}"><i class="feather icon-home"></i></a></li>
              <li class="breadcrumb-item"><a th:href="@{/admin/viewPendingVillageEditRequests}">Village-Update-Requests</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-header">
            <h5>Village-Update-Requests</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="thead-dark">
                <tr>
                    <th>Req-Id</th>
                    <th>Request-Date</th>
                    <th>Village-ID</th>
                    <th>Village Name</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="tempVillage : ${tempVillageRequests}"
                    th:data-id="${tempVillage.id}"
                    th:data-village-id="${tempVillage.villageId}"
                    th:data-requested-name="${tempVillage.villageName}"
                    th:data-requested-location="${tempVillage.villageLocation}"
                    th:data-requested-reg-no="${tempVillage.villageRegNumber}"
                    th:data-requested-authority-name="${tempVillage.villageAuthorityName}"
                    th:data-requested-description="${tempVillage.villageDescription}"
                    th:data-requested-rep-name="${tempVillage.legalRepresentativeName}"
                    th:data-requested-rep-position="${tempVillage.representativePosition}"
                    th:data-requested-off-id-no="${tempVillage.officialIdNumber}"
                    th:data-requested-contact-person-name="${tempVillage.contactPersonName}"
                    th:data-requested-contact-email="${tempVillage.contactEmail}"
                    th:data-requested-contact-no="${tempVillage.contactNo}"
                    th:data-requested-alt-contact-no="${tempVillage.altContactNo}"
                    th:data-requested-bank-name="${tempVillage.bankName}"
                    th:data-requested-acc-no="${tempVillage.bankAccountNumber}"
                    th:data-requested-tin="${tempVillage.tin}"
                    th:data-requested-type="${tempVillage.villageType}"
                    th:data-requested-latitude="${tempVillage.latitude}"
                    th:data-requested-longitude="${tempVillage.longitude}"
                    th:data-requested-stamporseal="${tempVillage.offStampOrSealFileName}"
                    th:data-requested-off-docfile="${tempVillage.offDocFileName}"
                    th:data-requested-status="${tempVillage.status}"

                    th:data-current-name="${currentVillageMap[tempVillage.villageId]?.villageName}"
                    th:data-current-location="${currentVillageMap[tempVillage.villageId]?.villageLocation}"
                    th:data-current-reg-no="${currentVillageMap[tempVillage.villageId]?.villageRegNumber}"
                    th:data-current-authority-name="${currentVillageMap[tempVillage.villageId]?.villageAuthorityName}"
                    th:data-current-description="${currentVillageMap[tempVillage.villageId]?.villageDescription}"
                    th:data-current-rep-name="${currentVillageMap[tempVillage.villageId]?.villageRepresentativeName}"
                    th:data-current-rep-position="${currentVillageMap[tempVillage.villageId]?.representativePosition}"
                    th:data-current-off-id-no="${currentVillageMap[tempVillage.villageId]?.officialIdNumber}"
                    th:data-current-contact-person-name="${currentVillageMap[tempVillage.villageId]?.contactPersonName}"
                    th:data-current-contact-email="${currentVillageMap[tempVillage.villageId]?.contactEmail}"
                    th:data-current-contact-no="${currentVillageMap[tempVillage.villageId]?.contactNo}"
                    th:data-current-alt-contact-no="${currentVillageMap[tempVillage.villageId]?.altContactNo}"
                    th:data-current-bank-name="${currentVillageMap[tempVillage.villageId]?.bankName}"
                    th:data-current-acc-no="${currentVillageMap[tempVillage.villageId]?.bankAccountNumber}"
                    th:data-current-tin="${currentVillageMap[tempVillage.villageId]?.tin}"
                    th:data-current-type="${currentVillageMap[tempVillage.villageId]?.villageType}"
                    th:data-current-latitude="${currentVillageMap[tempVillage.villageId]?.latitude}"
                    th:data-current-longitude="${currentVillageMap[tempVillage.villageId]?.longitude}"
                    th:data-current-stamporseal="${currentVillageMap[tempVillage.villageId]?.offStampOrSealFileName}"
                    th:data-current-off-docfile="${currentVillageMap[tempVillage.villageId]?.offDocFileName}" >


                  <td th:text="${tempVillage.id}"></td>
                  <td th:text="${tempVillage.requestedAt}"></td>
                  <td th:text="${tempVillage.villageId}"></td>
                  <td th:text="${tempVillage.villageName}"></td>
                  <td th:text="${tempVillage.status}"></td>
                  <td>
                    <button type="button"
                            class="btn btn-outline-primary view-btn"
                            th:data-id="${tempVillage.id}"
                            data-bs-toggle="modal"
                            data-bs-target="#villageEditModal">
                      View
                    </button>
                  </td>
                </tr>
                <tr th:if="${#lists.isEmpty(tempVillageRequests)}">
                  <td colspan="16" style="text-align: center; color: red;">No data available</td>
                </tr>
                </tbody>

              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="villageEditModal" tabindex="-1" aria-labelledby="villageEditModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="villageEditModalLabel">Village Update Request Details</h5>
        <button type="button" class="btn-close bg-light" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row gy-4">
          <!-- Column: Requested -->
          <div class="col-md-6">
            <h6 class="fw-bold text-primary">Requested Changes</h6>
            <div class="border-start ps-3">
              <p><strong>Name:</strong> <span id="requested-name"></span></p>
              <p><strong>Location:</strong> <span id="requested-location"></span></p>
              <p><strong>Reg. No:</strong> <span id="requested-reg-no"></span></p>
              <p><strong>Authority Name:</strong> <span id="requested-authority-name"></span></p>
              <p><strong>Description:</strong> <span id="requested-description"></span></p>
              <p><strong>Representative:</strong> <span id="requested-rep-name"></span> (<span id="requested-rep-position"></span>)</p>
              <p><strong>Official ID:</strong> <span id="requested-off-id-no"></span></p>
              <p><strong>Contact:</strong> <span id="requested-contact-person-name"></span> - <span id="requested-contact-no"></span></p>
              <p><strong>Alternate Contact:</strong> <span id="requested-alt-contact-no"></span></p>
              <p><strong>Email:</strong> <span id="requested-contact-email"></span></p>
              <p><strong>Bank:</strong> <span id="requested-bank-name"></span> (<span id="requested-acc-no"></span>)</p>
              <p><strong>TIN:</strong> <span id="requested-tin"></span></p>
              <p><strong>Type:</strong> <span id="requested-type"></span></p>
              <p><strong>Latitude:</strong> <span id="requested-latitude"></span></p>
              <p><strong>Longitude:</strong> <span id="requested-longitude"></span></p>

              <p><strong>Official Stamp/Seal:</strong>
                <img id="requested-stamp" src="" alt="Stamp/Seal" class="img-fluid rounded shadow-sm border" style="max-height: 100px;">
              </p>
              <div id="requested-doc-preview"></div>
            </div>
          </div>

          <!-- Column: Current -->
          <div class="col-md-6">
            <h6 class="fw-bold text-secondary">Current Details</h6>
            <div class="border-start ps-3">
              <p><strong>Name:</strong> <span id="current-name"></span></p>
              <p><strong>Location:</strong> <span id="current-location"></span></p>
              <p><strong>Reg. No:</strong> <span id="current-reg-no"></span></p>
              <p><strong>Authority Name:</strong> <span id="current-authority-name"></span></p>
              <p><strong>Description:</strong> <span id="current-description"></span></p>
              <p><strong>Representative:</strong> <span id="current-rep-name"></span> (<span id="current-rep-position"></span>)</p>
              <p><strong>Official ID:</strong> <span id="current-off-id-no"></span></p>
              <p><strong>Contact:</strong> <span id="current-contact-person-name"></span> - <span id="current-contact-no"></span></p>
              <p><strong>Alternate Contact:</strong> <span id="current-alt-contact-no"></span></p>
              <p><strong>Email:</strong> <span id="current-contact-email"></span></p>
              <p><strong>Bank:</strong> <span id="current-bank-name"></span> (<span id="current-acc-no"></span>)</p>
              <p><strong>TIN:</strong> <span id="current-tin"></span></p>
              <p><strong>Type:</strong> <span id="current-type"></span></p>
              <p><strong>Latitude:</strong> <span id="current-latitude"></span></p>
              <p><strong>Longitude:</strong> <span id="current-longitude"></span></p>

              <p><strong>Official Stamp/Seal:</strong>
                <img id="current-stamp" src="" alt="Stamp/Seal" class="img-fluid rounded shadow-sm border" style="max-height: 100px;">
              </p>
              <div id="current-doc-preview"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" id="approveBtn">Approve</button>
        <button type="button" class="btn btn-danger" id="rejectBtn" data-bs-toggle="modal" data-bs-target="#rejectModal">
          Reject
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border border-dark shadow">
            <div class="modal-header bg-black text-white">
                <h5 class="modal-title" id="rejectModalLabel">Reject Update Request</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-white text-dark">
                <textarea id="rejectionMessage" class="form-control border-dark" rows="4" placeholder="Enter your reason for rejection..."></textarea>
                <input type="hidden" id="rejectionRequestId" />
            </div>
            <div class="modal-footer bg-light border-top border-dark">
                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dark" id="sendRejectionBtn">Send</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".view-btn").forEach(function (button) {
        button.addEventListener("click", function () {
          const tr = button.closest("tr");

          document.getElementById("requested-name").textContent = tr.dataset.requestedName || '';
          document.getElementById("requested-location").textContent = tr.dataset.requestedLocation || '';
          document.getElementById("requested-reg-no").textContent = tr.dataset.requestedRegNo || '';
          document.getElementById("requested-authority-name").textContent = tr.dataset.requestedAuthorityName || '';
          document.getElementById("requested-description").textContent = tr.dataset.requestedDescription || '';
          document.getElementById("requested-rep-name").textContent = tr.dataset.requestedRepName || '';
          document.getElementById("requested-rep-position").textContent = tr.dataset.requestedRepPosition || '';
          document.getElementById("requested-off-id-no").textContent = tr.dataset.requestedOffIdNo || '';
          document.getElementById("requested-contact-person-name").textContent = tr.dataset.requestedContactPersonName || '';
          document.getElementById("requested-contact-email").textContent = tr.dataset.requestedContactEmail || '';
          document.getElementById("requested-contact-no").textContent = tr.dataset.requestedContactNo || '';
          document.getElementById("requested-alt-contact-no").textContent = tr.dataset.requestedAltContactNo || '';
          document.getElementById("requested-bank-name").textContent = tr.dataset.requestedBankName || '';
          document.getElementById("requested-acc-no").textContent = tr.dataset.requestedAccNo || '';
          document.getElementById("requested-tin").textContent = tr.dataset.requestedTin || '';
          document.getElementById("requested-type").textContent = tr.dataset.requestedType || '';
          document.getElementById("requested-latitude").textContent = tr.dataset.requestedLatitude || '';
          document.getElementById("requested-longitude").textContent = tr.dataset.requestedLongitude || '';

          const requestedStamp = tr.dataset.requestedStamporseal;
          document.getElementById("requested-stamp").src = requestedStamp ? '/uploads/village/' + requestedStamp : '';

          const requestedDoc = tr.dataset.requestedOffDocfile;
          const docPreview = document.getElementById("requested-doc-preview");
          docPreview.innerHTML = requestedDoc ? `<a href="/uploads/village/${requestedDoc}" target="_blank">${requestedDoc}</a>` : '';

          // Current Data
          document.getElementById("current-name").textContent = tr.dataset.currentName || '';
          document.getElementById("current-location").textContent = tr.dataset.currentLocation || '';
          document.getElementById("current-reg-no").textContent = tr.dataset.currentRegNo || '';
          document.getElementById("current-authority-name").textContent = tr.dataset.currentAuthorityName || '';
          document.getElementById("current-description").textContent = tr.dataset.currentDescription || '';
          document.getElementById("current-rep-name").textContent = tr.dataset.currentRepName || '';
          document.getElementById("current-rep-position").textContent = tr.dataset.currentRepPosition || '';
          document.getElementById("current-off-id-no").textContent = tr.dataset.currentOffIdNo || '';
          document.getElementById("current-contact-person-name").textContent = tr.dataset.currentContactPersonName || '';
          document.getElementById("current-contact-email").textContent = tr.dataset.currentContactEmail || '';
          document.getElementById("current-contact-no").textContent = tr.dataset.currentContactNo || '';
          document.getElementById("current-alt-contact-no").textContent = tr.dataset.currentAltContactNo || '';
          document.getElementById("current-bank-name").textContent = tr.dataset.currentBankName || '';
          document.getElementById("current-acc-no").textContent = tr.dataset.currentAccNo || '';
          document.getElementById("current-tin").textContent = tr.dataset.currentTin || '';
          document.getElementById("current-type").textContent = tr.dataset.currentType || '';
          document.getElementById("current-latitude").textContent = tr.dataset.currentLatitude || '';
          document.getElementById("current-longitude").textContent = tr.dataset.currentLongitude || '';

          const currentStamp = tr.dataset.currentStamporseal;
          document.getElementById("current-stamp").src = currentStamp ? '/uploads/village/' + currentStamp : '';

          const currentDoc = tr.dataset.currentOffDocfile;
          const currentDocPreview = document.getElementById("current-doc-preview");
          currentDocPreview.innerHTML = currentDoc ? `<a href="/uploads/village/${currentDoc}" target="_blank">${currentDoc}</a>` : '';

          // Store update request ID for approval/rejection
          document.getElementById("approveBtn").dataset.requestId = tr.dataset.id;
          document.getElementById("rejectBtn").dataset.requestId = tr.dataset.id;

          const approveBtn = document.getElementById("approveBtn");
             approveBtn.dataset.tr = JSON.stringify({ ...tr.dataset });
        });
      });

      document.getElementById("approveBtn").addEventListener("click", function () {
      console.log("Raw dataset.tr value:", this.dataset.tr);
      const requestId = this.dataset.requestId;
      const data = JSON.parse(this.dataset.tr); // stored in view-btn handler
      const updatePayload = {};

      const fields = [
        "name", "location", "regNo", "authorityName", "description",
        "repName", "repPosition", "offIdNo", "contactPersonName", "contactEmail",
        "contactNo", "altContactNo", "bankName", "accNo", "tin",
        "type", "latitude", "longitude", "stamporseal", "offDocfile"
      ];

      fields.forEach(field => {
        const requestedKey = `requested${capitalize(field)}`;
        const currentKey = `current${capitalize(field)}`;

        const requestedVal = data[requestedKey]?.trim();
        const currentVal = data[currentKey]?.trim();

        if (requestedVal && requestedVal !== currentVal) {
          updatePayload[field] = requestedVal;
        }
      });

      if (Object.keys(updatePayload).length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'No Changes Detected',
          text: 'The requested data matches the current data. No update is needed.',
          timer: 3000,
          showConfirmButton: false
        });
        return;
      }

      fetch("/admin/approveVillageUpdateRequest/" + requestId, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(updatePayload)
      })
      .then(res => {
        if (res.ok) {
           window.location.href = "/admin/updatedVillages";
        }
      })
      .catch(() => {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'An error occurred during approval.',
        }).then(() => {
        window.location.reload();
        });
      });

          function capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
          }
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("rejectBtn").addEventListener("click", function () {
        const requestId = this.dataset.requestId;
        document.getElementById("rejectionRequestId").value = requestId;
      });

      document.getElementById("sendRejectionBtn").addEventListener("click", function () {
        const requestId = document.getElementById("rejectionRequestId").value;
        const message = document.getElementById("rejectionMessage").value.trim();

        if (!message) {
          Swal.fire({
            icon: 'warning',
            title: 'Empty Message',
            text: 'Please enter a message before rejecting.',
            confirmButtonColor: '#ef4444'
          });
          return;
        }

        fetch("/admin/rejectVillageUpdateRequest/" + requestId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message: message })
        })
        .then(res => {
          if (res.ok) {
            window.location.href = "/admin/updatedVillages";
          }
        })
        .catch(() => {
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'An error occurred during rejection.',
            confirmButtonColor: '#ef4444'
          }).then(() => {
        window.location.reload();
        });
        });
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const markReadBtn = document.querySelector(".mark-read-link");
        const clearAllBtn = document.querySelector(".clear-all-link");
        const notiBody = document.querySelector(".noti-body");
        const countBadge = document.getElementById("notification-count");

        const updateCount = () => {
            const unread = notiBody.querySelectorAll(".notification.unread").length;
            countBadge.textContent = unread > 0 ? unread : "0";
        };

        markReadBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                const res = await fetch("/admin/inbox/markAllRead", {
                    method: "POST"
                });
                if (res.ok) {
                    notiBody.querySelectorAll(".notification.unread").forEach(item => {
                        item.classList.remove("unread");
                        item.classList.add("read");
                    });
                    updateCount();
                }
            } catch (err) {
                console.error("Error marking all as read:", err);
            }
        });

        clearAllBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                const res = await fetch("/admin/inbox/clearAll", {
                    method: "DELETE"
                });
                if (res.ok) {
                    notiBody.innerHTML = `
                        <li class="n-title">
                            <p class="m-b-0 text-muted">No notifications</p>
                        </li>
                    `;
                    updateCount();
                }
            } catch (err) {
                console.error("Error clearing notifications:", err);
            }
        });

        notiBody.addEventListener("click", async (e) => {
            const item = e.target.closest(".notification.unread");
            if (!item) return;
            const id = item.dataset.id; // needs th:data-id in your HTML
            try {
                const res = await fetch(`/admin/inbox/markRead/${id}`, {
                    method: "POST"
                });
                if (res.ok) {
                    item.classList.remove("unread");
                    item.classList.add("read");
                    updateCount();
                }
            } catch (err) {
                console.error("Error marking notification read:", err);
            }
        });
        updateCount();
    });

</script>
<script src="/Admin/assets/js/vendor-all.min.js"></script>
<script src="/Admin/assets/js/plugins/bootstrap.min.js"></script>
<script src="/Admin/assets/js/pcoded.min.js"></script>

</body>

</html>
