
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>All Villages</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="" />
    <meta name="keywords" content="">
    <meta name="author" content="Phoenixcoded" />
    <link rel="icon" th:href="@{/Village/VillageAdmin/assets/images/favicon.ico}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/Admin/assets/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .forms-container {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        padding: 12px;
        margin-bottom: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        .forms-container select,
        .forms-container input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #6c757d;
            border-radius: 6px;
            outline: none;
            transition: 0.3s ease-in-out;
        }

        .forms-container select:focus,
        .forms-container input:focus {
            border-color: #333;
            box-shadow: 0 0 8px rgba(100, 100, 100, 0.6);
            outline: none;
        }

        .forms-container button {
            padding: 10px 18px;
            background: #1f1f1f;
            color: white;
            font-size: 16px;
            border: 2px solid #1f1f1f;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }

        .forms-container button:hover {
            background: #333333;
            border-color: #333333;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 16px;
            cursor: pointer;
            gap: 6px;
            color: #495057;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
            accent-color: #6c757d;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .forms-container {
            flex-direction: column;
            align-items: flex-end;
            }

        .forms-container form {
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }

        .forms-container input,
        .forms-container select {
            width: 100%;
        }
        }

       .modal-overlay {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
       }

       .modal-content {
          background: #fff;
          border-radius: 10px;
          max-width: 800px;
          width: 90%;
          padding: 20px 30px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
          overflow-y: auto;
          max-height: 90vh;
          position: relative;
       }

       .modal-section {
          margin-bottom: 20px;
       }

       .modal-section h3 {
          margin-bottom: 10px;
          color: #333;
          border-bottom: 1px solid #ccc;
          padding-bottom: 5px;
       }

       .status-badge {
          padding: 4px 8px;
          border-radius: 6px;
          font-weight: bold;
       }

       .status-Approved {
          background-color: #d4edda;
          color: #155724;
       }
       .status-Rejected {
          background-color: #f8d7da;
          color: #721c24;
       }
       .status-Pending {
          background-color: #fff3cd;
          color: #856404;
       }

       .photos-container img {
          height: 100px;
          margin: 5px;
          border-radius: 8px;
          object-fit: cover;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
       }

       .doc-image {
          height: 80px;
          border-radius: 6px;
          margin-top: 5px;
          box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
       }

       .close-btn {
          position: absolute;
          top: 10px;
          right: 15px;
          background: transparent;
          border: none;
          font-size: 28px;
          font-weight: bold;
          color: #888;
          cursor: pointer;
       }

       .close-btn:hover {
          color: #000;
       }

        .swal2-popup.village-image-modal .swal2-image {
          max-width: 90vw;
          max-height: 80vh;
          object-fit: contain;
        }

         .notification.unread {
            background-color: #f5f5f5;
            border-left: 4px solid #28a745;
        }
        .notification.read {
            opacity: 0.7;
        }
           .noti-head {
        background-color: #000;
        color: #fff;
        padding: 10px;
        }

        .noti-head a {
            color: #fff !important;
            text-decoration: none;
            font-weight: 500;
        }

        .noti-head a:hover {
            text-decoration: underline;
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }

        .notification-item.unread {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .notification-item.read {
            background-color: #e0e0e0;
            font-weight: normal;
        }

    </style>

</head>
<body class="">
<div class="loader-bg">
    <div class="loader-track">
        <div class="loader-fill"></div>
    </div>
</div>
<nav class="pcoded-navbar">
    <div class="navbar-wrapper">
        <div class="navbar-content scroll-div " >

            <div class="">
                <div class="main-menu-header">
                    <img class="img-radius" th:src="@{'/uploads/admin/' + ${admin.adminProfileImage}}" alt="Admin">
                    <div class="user-details">
                        <span th:text="${admin.adminName}"></span>
                        <div id="more-details">Administrator<i class="fa fa-chevron-down m-l-5"></i></div>
                    </div>
                </div>
                <div class="collapse" id="nav-user-link">
                    <ul class="list-unstyled">
                        <li class="list-group-item"><a th:href="@{/admin/profile}"><i class="feather icon-user m-r-5"></i>View Profile</a></li>
                        <li class="list-group-item"><a th:href="@{/admin/logout}"><i class="feather icon-log-out m-r-5"></i>Logout</a></li>
                    </ul>
                </div>
            </div>

            <ul class="nav pcoded-inner-navbar ">
                <li class="nav-item pcoded-menu-caption">
                    <label>Home</label>
                </li>
                <li class="nav-item">
                    <a th:href="@{/admin/home}" class="nav-link "><span class="pcoded-micon"><i class="feather icon-home"></i></span><span class="pcoded-mtext">Dashboard</span></a>
                </li>
                <li class="nav-item pcoded-hasmenu">
                    <a href="#!" class="nav-link "><span class="pcoded-micon"><i class="feather icon-layout"></i></span><span class="pcoded-mtext">Village</span></a>
                    <ul class="pcoded-submenu">
                        <li><a th:href="@{/admin/requests}" >Requests</a></li>
                        <li><a th:href="@{/admin/viewAllVillages}" >View All</a></li>
                        <li><a th:href="@{/admin/viewPendingVillageEditRequests}" >Update-Requests</a></li>
                        <li><a th:href="@{/admin/updatedVillages}" >All Update Reqs</a></li>
                    </ul>
                </li>
                <li class="nav-item pcoded-menu-caption">
                    <label>Cultural Activities</label>
                </li>
                <li class="nav-item pcoded-hasmenu">
                    <a href="#!" class="nav-link "><span class="pcoded-micon"><i class="feather icon-box"></i></span><span class="pcoded-mtext">Activities</span></a>
                    <ul class="pcoded-submenu">
                        <li><a th:href="@{/admin/viewActivityRequests}" >Requests</a></li>
                        <li><a th:href="@{/admin/viewAllActivities}" >View All</a></li>
                    </ul>
                </li>
                <li class="nav-item pcoded-menu-caption">
                    <label>Others</label>
                </li>
                <li class="nav-item">
                    <a th:href="@{/admin/allUsers}" class="nav-link "><span class="pcoded-micon"><i class="feather icon-file-text"></i></span><span class="pcoded-mtext">Users</span></a>
                </li>
                <li class="nav-item">
                    <a th:href="@{/admin/feedbacks}" class="nav-link "><span class="pcoded-micon"><i class="feather icon-align-justify"></i></span><span class="pcoded-mtext">FeedBacks</span></a>
                </li>
            </ul>

        </div>
    </div>
</nav>
<header class="navbar pcoded-header navbar-expand-lg navbar-light header-dark">


    <div class="m-header">
        <a class="mobile-menu" id="mobile-collapse" href="#!"><span></span></a>
        <a href="#!" class="b-brand">
            <img src="/Admin/assets/images/logo.png" alt="" class="logo">
            <img src="/Admin/assets/images/logo-icon.png" alt="" class="logo-thumb">
        </a>
        <a href="#!" class="mob-toggler">
            <i class="feather icon-more-vertical"></i>
        </a>
    </div>
    <div class="collapse navbar-collapse">

        <ul class="navbar-nav ml-auto">
            <li>
                <div class="dropdown">
                    <a class="dropdown-toggle" href="#" data-toggle="dropdown">
                        <i class="icon feather icon-bell"></i>
                        <span id="notification-count" class="badge badge-pill badge-danger"
                              th:text="${messages.size()}">0</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right notification">
                        <div class="noti-head">
                            <h6 class="d-inline-block m-b-0">Notifications</h6>
                            <div class="float-right">
                                <a href="#!" class="mark-read-link m-r-10">mark as read</a>
                                <a href="#!" class="clear-all-link">clear all</a>
                            </div>
                        </div>
                        <ul class="noti-body">
                            <li class="n-title"><p class="m-b-0">NEW</p></li>
                            <li class="notification"
                                th:each="message : ${messages}"
                                th:data-id="${message.id}"
                                th:classappend="${message.isRead} ? 'read' : 'unread'">
                                <div class="media">
                                    <img class="img-radius"
                                         th:src="${message.village?.villageProfileImage != null ? '/uploads/village/' + message.village.villageProfileImage : '/Admin/assets/images/user/default.jpg'}"
                                         alt="Village image">
                                    <div class="media-body">
                                        <p>
                                            <strong th:text="${message.village?.villageName ?: 'Unknown Village'}">Village Name</strong>
                                            <span class="n-time text-muted">
                                                <i class="icon feather icon-clock m-r-10"></i>
                                                <span th:text="${message.timestamp != null ? #temporals.format(message.timestamp, 'HH:mm') : '—'}"></span>
                                            </span>
                                            <span th:if="${#temporals.day(message.timestamp) == #temporals.day(#temporals.createNow())}"
                                                  class="badge bg-success ml-2">New</span>
                                        </p>
                                        <p th:text="${message.message}">Message content</p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <div class="noti-footer">
                            <a th:href="@{/admin/inbox}">show all</a>
                        </div>
                    </div>
                </div>
            </li>
            <li>
                <div class="dropdown drp-user">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="feather icon-user"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right profile-notification">
                        <div class="pro-head">
                            <img th:src="@{'/uploads/admin/' + ${admin.adminProfileImage}}" alt="Admin" class="img-radius" >
                            <span th:text="${admin.adminName}"></span>
                            <a th:href="@{/admin/logout}" class="dud-logout" title="Logout">
                                <i class="feather icon-log-out"></i>
                            </a>
                        </div>
                        <ul class="pro-body">
                            <li><a th:href="@{/admin/profile}" class="dropdown-item"><i class="feather icon-user"></i> Profile</a></li>
                            <li><a th:href="@{/admin/viewResetPassword}" class="dropdown-item"><i class="feather icon-mail"></i>Reset-Password</a></li>
                            <li><a th:href="@{/admin/logout}" class="dropdown-item"><i class="feather icon-lock"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </li>
        </ul>
    </div>


</header>

<div class="pcoded-main-container">
    <div class="pcoded-content">
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h5 class="m-b-10">All Villages</h5>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a th:href="@{/admin/home}"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a th:href="@{/admin/viewAllVillages}">All-Villages</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h5>All-Villages</h5>
                    </div>
                    <div class="card-body">
                        <div class="forms-container">
                            <form id="currentStatusForm" th:action="@{/admin/viewAllVillages}" method="get">
                                <select id="villageCurrentStatusFilter" name="selectedCurrentStatus" onchange="submitCurrentStatusForm()">
                                    <option value="All" th:selected="${selectedCurrentStatus == 'All'}">All</option>
                                    <option value="Available" th:selected="${selectedCurrentStatus == 'Available'}">Available</option>
                                    <option value="Unavailable" th:selected="${selectedCurrentStatus == 'Unavailable'}">Unavailable</option>
                                    <option value="Deactivated" th:selected="${selectedCurrentStatus == 'Deactivated'}">Deactivated</option>
                                </select>
                                <input type="hidden" id="hiddenSearchKeywordType" name="searchKeyword" value="">
                                <input type="hidden" id="hiddenStatusFilterType" name="statusFilter" th:value="${statusFilter}">
                            </form>

                            <form id="searchVillageForm" th:action="@{/admin/viewAllVillages}" method="get">
                                <input type="text" id="searchVillageName" name="searchVillageName" th:value="${searchVillageName}" placeholder="Search Villages...">
                                <button type="submit" onclick="submitSearchForm()">Search</button>
                                <input type="hidden" id="hiddenSelectedCurrentStatusSearch" name="selectedCurrentStatus" value="All">
                                <input type="hidden" id="hiddenStatusFilterSearch" name="statusFilter" th:value="${statusFilter}">
                            </form>

                            <form id="villageStatusForm" th:action="@{/admin/viewAllVillages}" method="get">
                                <label>
                                    <input type="checkbox" id="approvedCheck" name="villageStatusFilter" value="Approved"
                                           th:checked="${villageStatusFilter == 'Approved'}" onchange="toggleStatus('Approved')"> Approved
                                </label>
                                <label>
                                    <input type="checkbox" id="rejectedCheck" name="villageStatusFilter" value="Rejected"
                                           th:checked="${villageStatusFilter == 'Rejected'}" onchange="toggleStatus('Rejected')"> Rejected
                                </label>
                                <input type="hidden" id="hiddenSelectedCurrentStatus" name="selectedCurrentStatus" th:value="${selectedCurrentStatus}">
                                <input type="hidden" id="hiddenSearchKeywordStatus" name="searchKeyword" th:value="${searchVillageName}">
                            </form>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                <tr>
                                    <th>Reg-Date</th>
                                    <th>Village-ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Location</th>
                                    <th>Reg-number</th>
                                    <th>Authority Name</th>
                                    <th>Current-Status</th>
                                    <th>Status</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="village : ${villages}"
                                    th:data-id="${village.villageId}"
                                    th:data-reg-date="${#temporals.format(village.registeredDate, 'dd-MM-yyyy HH:mm')}"
                                    th:data-village-name="${village.villageName}"
                                    th:data-village-email="${village.villageEmail}"
                                    th:data-village-type="${village.villageType}"
                                    th:data-village-location="${village.villageLocation}"
                                    th:data-latitude="${village.latitude}"
                                    th:data-longitude="${village.longitude}"
                                    th:data-village-description="${village.villageDescription}"
                                    th:data-village-reg-no="${village.villageRegNumber}"
                                    th:data-authority-name="${village.villageAuthorityName}"
                                    th:data-rep-name="${village.villageRepresentativeName}"
                                    th:data-rep-position="${village.representativePosition}"
                                    th:data-off-id-no="${village.officialIdNumber}"
                                    th:data-contact-email="${village.contactEmail}"
                                    th:data-contact-no="${village.contactNo}"
                                    th:data-altcontact-no="${village.altContactNo}"
                                    th:data-bank-name="${village.bankName}"
                                    th:data-acc-no="${village.bankAccountNumber}"
                                    th:data-tin="${village.tin}"
                                    th:data-off-doc="${village.offDocFileName}"
                                    th:data-stamp="${village.offStampOrSealFileName}"
                                    th:data-village-photos="${#strings.listJoin(village.villagePhotos, '||')}"
                                    th:data-current-status="${village.villageCurrentStatus}"
                                    th:data-village-status="${village.villageStatus}"
                                    onclick="showVillageDetails(this)">


                                    <td th:text="${village.registeredDate != null? #temporals.format(village.registeredDate, 'dd-MM-yyyy HH:mm') : '❌'}"></td>
                                    <td th:text="${village.villageId?: '❌'}"></td>
                                    <td th:text="${village.villageName?: '❌'}"></td>
                                    <td th:text="${village.villageEmail?: '❌'}"></td>
                                    <td th:text="${village.villageLocation?: '❌'}"></td>
                                    <td th:text="${village.villageRegNumber?: '❌'}"></td>
                                    <td th:text="${village.villageAuthorityName?: '❌'}"></td>
                                    <td th:text="${village.villageCurrentStatus?: '❌'}"></td>
                                    <td th:text="${village.villageStatus?: '❌'}" class="village-status"></td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(villages)}">
                                    <td colspan="16" style="text-align: center; color: red;">No data available</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="villageModal" class="modal-overlay" onclick="closeModalOutside(event)">
    <div class="modal-content" tabindex="0">
        <button class="close-btn" onclick="closeModal()">×</button>
        <h2>Village Details</h2>

        <div class="modal-section">
            <h3>Basic Info</h3>
            <p><strong>Name:</strong> <span id="villageName"></span></p>
            <p><strong>Reg No:</strong> <span id="villageRegNo"></span></p>
            <p><strong>Email:</strong> <span id="villageEmail"></span></p>
            <p><strong>Location:</strong> <span id="villageLocation"></span></p>
            <p><strong>Latitude:</strong> <span id="villageLatitude"></span></p>
            <p><strong>Longitude:</strong> <span id="villageLongitude"></span></p>
            <p><strong>Date of Registration:</strong> <span id="dateOfRegistration"></span></p>
        </div>

        <div class="modal-section">
            <h3>Representative Info</h3>
            <p><strong>Name:</strong> <span id="repName"></span></p>
            <p><strong>Position:</strong> <span id="repPosition"></span></p>
            <p><strong>Email:</strong> <span id="contactEmail"></span></p>
            <p><strong>Primary Contact:</strong> <span id="contactNo"></span></p>
            <p><strong>Alternate Contact:</strong> <span id="altContactNo"></span></p>
        </div>

        <div class="modal-section">
            <h3>Status</h3>
            <p><strong>Registration Status:</strong> <span id="statusBadge"></span></p>
            <p><strong>Current Status:</strong> <span id="currentStatusBadge"></span></p>
        </div>

        <div class="modal-section">
            <h3>Bank Details</h3>
            <p><strong>Account Holder:</strong> <span id="accountHolderName"></span></p>
            <p><strong>Account Number:</strong> <span id="accountNumber"></span></p>
            <p><strong>IFSC Code:</strong> <span id="ifscCode"></span></p>
            <p><strong>Bank Name:</strong> <span id="bankName"></span></p>
        </div>

        <div class="modal-section">
            <h3>Village Photos</h3>
            <div id="villagePhotosContainer" class="photos-container"></div>
        </div>

        <div class="modal-section">
            <h3>Documents</h3>
            <div id="documentsContainer">
                <p><strong>Stamp:</strong> <img id="stampImage" class="doc-image" /></p>
                <p><strong>Office Document:</strong> <span id="offDocWrapper"><img id="offDocImage" class="doc-image" /></span></p>
            </div>
        </div>

        <div class="modal-section">
            <h3>Map</h3>
            <iframe id="mapFrame" width="100%" height="200" frameborder="0" style="border:0;" allowfullscreen loading="lazy"></iframe>
        </div>
    </div>
</div>
<script>
function submitCurrentStatusForm() {
   document.getElementById("hiddenSearchKeywordType").value = "";
   document.getElementById("currentStatusForm").submit();
}

function submitSearchForm() {
    document.getElementById("hiddenSelectedCurrentStatusSearch").value = "All";
    document.getElementById("searchVillageForm").submit();
}

function toggleStatus(status) {
    let approvedCheck = document.getElementById("approvedCheck");
    let rejectedCheck = document.getElementById("rejectedCheck");
    let statusForm = document.getElementById("villageStatusForm");

    if (status === "Approved") {
        if (approvedCheck.checked) {
            rejectedCheck.checked = false;
        }
    } else if (status === "Rejected") {
        if (rejectedCheck.checked) {
            approvedCheck.checked = false;
        }
    }
    statusForm.submit();
}
function showVillageDetails(row) {
  const modal = document.getElementById("villageModal");

  document.getElementById("villageName").innerText = row.getAttribute("data-village-name") || 'N/A';
  document.getElementById("villageEmail").innerText = row.getAttribute("data-village-email") || 'N/A';
  document.getElementById("villageLocation").innerText = row.getAttribute("data-village-location") || 'N/A';
  document.getElementById("villageLatitude").innerText = row.getAttribute("data-latitude") || 'N/A';
  document.getElementById("villageLongitude").innerText = row.getAttribute("data-longitude") || 'N/A';
  document.getElementById("dateOfRegistration").innerText = row.getAttribute("data-reg-date") || 'N/A';
  document.getElementById("villageRegNo").innerText = row.getAttribute("data-village-reg-no") || 'N/A';
  document.getElementById("repName").innerText = row.getAttribute("data-rep-name") || 'N/A';
  document.getElementById("repPosition").innerText = row.getAttribute("data-rep-position") || 'N/A';
  document.getElementById("contactEmail").innerText = row.getAttribute("data-contact-email") || 'N/A';
  document.getElementById("contactNo").innerText = row.getAttribute("data-contact-no") || 'N/A';
  document.getElementById("altContactNo").innerText = row.getAttribute("data-altcontact-no") || 'N/A';

  const status = row.getAttribute("data-village-status") || 'Pending';
  const currentStatus = row.getAttribute("data-current-status") || 'Unavailable';
  document.getElementById("statusBadge").innerHTML = `<span class="status-badge status-${status}">${status}</span>`;
  document.getElementById("currentStatusBadge").innerHTML = `<span class="status-badge status-${currentStatus}">${currentStatus}</span>`;

  document.getElementById("accountHolderName").innerText = row.getAttribute("data-village-name") || 'N/A';
  document.getElementById("accountNumber").innerText = row.getAttribute("data-acc-no") || 'N/A';
  document.getElementById("ifscCode").innerText = row.getAttribute("data-ifsc-code") || 'N/A';
  document.getElementById("bankName").innerText = row.getAttribute("data-bank-name") || 'N/A';

  const photosContainer = document.getElementById("villagePhotosContainer");
  photosContainer.innerHTML = '';
  const photoList = row.getAttribute("data-village-photos");
      if (photoList && photoList.trim()) {
        photoList.split("||").forEach(photo => {
      const img = document.createElement("img");
      img.src = `/uploads/village/${photo.trim()}`;
      img.alt = "Village Photo";
      img.width = 120;
      img.height = 80;
      photosContainer.appendChild(img);
    });


        photosContainer.querySelectorAll("img").forEach(img => {
          img.classList.add("village-photo");
          img.style.cursor = "pointer";
          img.addEventListener("click", function () {
            const imageUrl = this.getAttribute("src");


            const villageModal = document.getElementById("villageModal");
            villageModal.style.display = "none";

            Swal.fire({
              title: 'Village Photo',
              imageUrl: imageUrl,
              imageAlt: 'Village Image',
              showCloseButton: true,
              showConfirmButton: false,
              width: 'auto',
              padding: '1em',
              background: '#fff',
              customClass: {
                popup: 'village-image-modal'
              },
              didClose: () => {
                // Restore village modal after preview closes
                villageModal.style.display = "flex";
              }
            });
          });
        });

          } else {
            photosContainer.innerHTML = "<p>No photos available ❌</p>";
          }

const stampImg = row.getAttribute("data-stamp");
document.getElementById("stampImage").src = stampImg ? `/uploads/village/${stampImg}` : '';

const offDocImg = row.getAttribute("data-off-doc");
const offDocImage = document.getElementById("offDocImage");
const offDocContainer = offDocImage.parentElement;

Array.from(offDocContainer.children).forEach(child => {
  if (child !== offDocImage) {
    child.remove();
  }
});

const fileExtension = offDocImg ? offDocImg.split('.').pop().toLowerCase() : null;

if (offDocImg) {
  const filePath = `/uploads/village/${offDocImg}`;

  if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
    offDocImage.style.display = "block";
    offDocImage.src = filePath;
  } else if (fileExtension === 'pdf') {
    offDocImage.style.display = "none";
    const iframe = document.createElement("iframe");
    iframe.src = filePath;
    iframe.width = "100%";
    iframe.height = "300px";
    offDocContainer.appendChild(iframe);
  } else if (fileExtension === 'doc' || fileExtension === 'docx') {
    offDocImage.style.display = "none";
    const link = document.createElement("a");
    link.href = filePath;
    link.target = "_blank";
    link.className = "doc-link";
    link.textContent = "View Document";
    offDocContainer.appendChild(link);
  } else {
    offDocImage.style.display = "none";
    offDocContainer.appendChild(document.createTextNode("Unsupported file format ❌"));
  }
} else {
  offDocImage.style.display = "none";
  offDocContainer.appendChild(document.createTextNode("No document uploaded ❌"));
}

  const lat = row.getAttribute("data-latitude");
  const lng = row.getAttribute("data-longitude");
  const mapFrame = document.getElementById("mapFrame");
  if (lat && lng) {
    mapFrame.src = `https://maps.google.com/maps?q=${lat},${lng}&hl=es&z=14&output=embed`;
  } else {
    mapFrame.src = '';
  }

  modal.style.display = "flex";
  document.querySelector(".modal-content").focus();
}

function closeModal() {
  document.getElementById("villageModal").style.display = "none";
}

function closeModalOutside(e) {
  if (e.target.classList.contains("modal-overlay")) {
    closeModal();
  }
}

document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    closeModal();
  }
});

document.addEventListener("DOMContentLoaded", () => {
    const markReadBtn = document.querySelector(".mark-read-link");
    const clearAllBtn = document.querySelector(".clear-all-link");
    const notiBody = document.querySelector(".noti-body");
    const countBadge = document.getElementById("notification-count");

        const updateCount = () => {
            const unread = notiBody.querySelectorAll(".notification.unread").length;
            countBadge.textContent = unread > 0 ? unread : "0";
        };

        markReadBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                const res = await fetch("/admin/inbox/markAllRead", {
                    method: "POST"
                });
                if (res.ok) {
                    notiBody.querySelectorAll(".notification.unread").forEach(item => {
                        item.classList.remove("unread");
                        item.classList.add("read");
                    });
                    updateCount();
                }
            } catch (err) {
                console.error("Error marking all as read:", err);
            }
        });

        clearAllBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                const res = await fetch("/admin/inbox/clearAll", {
                    method: "DELETE"
                });
                if (res.ok) {
                    notiBody.innerHTML = `
                        <li class="n-title">
                            <p class="m-b-0 text-muted">No notifications</p>
                        </li>
                    `;
                    updateCount();
                }
            } catch (err) {
                console.error("Error clearing notifications:", err);
            }
        });

    notiBody.addEventListener("click", async (e) => {
        const item = e.target.closest(".notification.unread");
            if (!item) return;
            const id = item.dataset.id; // needs th:data-id in your HTML
            try {
                const res = await fetch(`/admin/inbox/markRead/${id}`, {
                    method: "POST"
                });
                if (res.ok) {
                    item.classList.remove("unread");
                    item.classList.add("read");
                    updateCount();
                }
            } catch (err) {
                console.error("Error marking notification read:", err);
            }
     });
     updateCount();
});
</script>
<script src="/Admin/assets/js/vendor-all.min.js"></script>
<script src="/Admin/assets/js/plugins/bootstrap.min.js"></script>
<script src="/Admin/assets/js/pcoded.min.js"></script>

</body>

</html>
